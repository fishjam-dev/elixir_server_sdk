version: "3"

services:
  test:
    image: hexpm/elixir:1.14.4-erlang-25.3.2-alpine-3.16.5
    command: sh -c "cd app/ && apk add git && mix local.hex --force && mix local.rebar --force && mix deps.get && mix coveralls.json --warnings-as-errors $TEST_ARGS"
    environment:
      - MIX_ENV=integration_test
    volumes:
      - .:/app
    ports:
      - "4000:4000"
    networks:
      test_network:
        ipv4_address: 172.28.0.2
    depends_on:
      jellyfish:
        condition: service_healthy

  jellyfish:
    extends:
      file: docker-compose-dev.yaml
      service: jellyfish
    environment:
      - JF_HOST=jellyfish:5002
    networks:
      test_network:
        ipv4_address: 172.28.0.3

networks:
  test_network:
    ipam:
      config:
        - subnet: 172.28.0.0/24
